<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤æ‚æ¨¡å‹åŠ è½½ - GLBæ¨¡å‹åŠ è½½ç¤ºä¾‹</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background:            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                2000
            );
            // è®¾ç½®ä»°è§†è§’ï¼šç›¸æœºä½ç½®è¾ƒä½ï¼Œå‘ä¸Šçœ‹æ¨¡å‹
            camera.position.set(15, 3, 15);radient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #canvas {
            display: block;
        }

        .ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            min-width: 250px;
            z-index: 100;
        }

        .ui-panel h3 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ccc;
        }

        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }

        .control-group button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
            transition: background 0.3s;
        }

        .control-group button:hover {
            background: #45a049;
        }

        .control-group button.active {
            background: #ff9800;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            min-width: 200px;
            z-index: 100;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 300px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .error-message {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #f44336;
            max-width: 400px;
            text-align: center;
        }

        .success-message {
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <!-- åŠ è½½ç•Œé¢ -->
        <div id="loadingScreen" class="loading-screen">
            <div class="loader"></div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="loadingText">æ­£åœ¨åŠ è½½åŸå¸‚åœºæ™¯æ¨¡å‹...</div>
            <div id="loadingProgress">0%</div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="ui-panel">
            <h3>ğŸ™ï¸ åŸå¸‚åœºæ™¯æ¨¡å‹</h3>
            
            <div class="control-group">
                <label>æ¨¡å‹ç¼©æ”¾</label>
                <input type="range" id="scaleSlider" min="0.1" max="5" step="0.1" value="1">
                <span id="scaleValue">1.0</span>
            </div>

            <div class="control-group">
                <label>ç›¸æœºæ§åˆ¶</label>
                <button id="resetCamera">é‡ç½®è§†è§’</button>
                <button id="topView">ä¿¯è§†å›¾</button>
                <button id="sideView">ä¾§è§†å›¾</button>
            </div>

            <div class="control-group">
                <label>è§†è§‰æ•ˆæœ</label>
                <button id="toggleWireframe">çº¿æ¡†æ¨¡å¼</button>
                <button id="toggleShadows" class="active">é˜´å½±å¼€å…³</button>
                <button id="toggleFog">é›¾æ•ˆå¼€å…³</button>
            </div>

            <div class="control-group">
                <label>å…‰ç…§è°ƒèŠ‚</label>
                <input type="range" id="lightIntensity" min="0" max="2" step="0.1" value="1">
                <span id="lightValue">1.0</span>
            </div>
        </div>

        <!-- ä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
            <h4>ğŸ“Š æ¨¡å‹ä¿¡æ¯</h4>
            <div id="modelInfo">
                <p>æ–‡ä»¶: <span id="fileName">city_scene.glb</span></p>
                <p>é¡¶ç‚¹æ•°: <span id="vertexCount">-</span></p>
                <p>é¢æ•°: <span id="faceCount">-</span></p>
                <p>æè´¨æ•°: <span id="materialCount">-</span></p>
                <p>FPS: <span id="fps">-</span></p>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // å¯¼å…¥Three.jså’Œç›¸å…³æ¨¡å—
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let model;
        let wireframeMode = false;
        let shadowsEnabled = true;
        let fogEnabled = true;
        let directionalLight;
        
        // æ€§èƒ½ç›‘æ§
        let frameCount = 0;
        let lastTime = Date.now();
        
        // UI å…ƒç´ 
        const loadingScreen = document.getElementById('loadingScreen');
        const progressFill = document.getElementById('progressFill');
        const loadingText = document.getElementById('loadingText');
        const loadingProgress = document.getElementById('loadingProgress');

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.Fog(0x1a1a2e, 50, 200);

            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                2000
            );
            // è®¾ç½®åˆå§‹ç›¸æœºä½ç½®ä¸ºä»°è§†è§’åº¦ï¼Œé€‚åº”æ¨¡å‹Yè½´å¯¹åº”Zè½´çš„æƒ…å†µ
            camera.position.set(5, 1, 5);

            // åˆ›å»ºæ¸²æŸ“å™¨
            const canvas = document.getElementById('canvas');
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1;

            // åˆ›å»ºè½¨é“æ§åˆ¶å™¨
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2;
            controls.minDistance = 2;
            controls.maxDistance = 200;

            // æ·»åŠ å…‰æº
            setupLighting();

            // åŠ è½½æ¨¡å‹
            loadGLBModel();

            // è®¾ç½®UIäº‹ä»¶ç›‘å¬å™¨
            setupUIControls();

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', onWindowResize);
        }

        // è®¾ç½®å…‰ç…§
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            // ä¸»æ–¹å‘å…‰
            directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 4096;
            directionalLight.shadow.mapSize.height = 4096;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 200;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);

            // è¡¥å……å…‰æº
            const pointLight1 = new THREE.PointLight(0x4080ff, 0.3, 100);
            pointLight1.position.set(-30, 20, 30);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xff8040, 0.3, 100);
            pointLight2.position.set(30, 20, -30);
            scene.add(pointLight2);

            // åŠçƒå…‰æº
            const hemisphereLight = new THREE.HemisphereLight(0x87ceeb, 0x362d1d, 0.4);
            scene.add(hemisphereLight);
        }

        // åŠ è½½GLBæ¨¡å‹
        function loadGLBModel() {
            const loader = new GLTFLoader();
            
            // è®¾ç½®DRACOè§£ç å™¨ï¼ˆå¯é€‰ï¼Œç”¨äºå‹ç¼©æ¨¡å‹ï¼‰
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/libs/draco/');
            loader.setDRACOLoader(dracoLoader);
            
            // åŠ è½½è¿›åº¦å›è°ƒ
            function onProgress(xhr) {
                if (xhr.lengthComputable) {
                    const percentComplete = (xhr.loaded / xhr.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    loadingProgress.textContent = Math.round(percentComplete) + '%';
                    loadingText.textContent = `æ­£åœ¨åŠ è½½åŸå¸‚åœºæ™¯æ¨¡å‹... ${Math.round(percentComplete)}%`;
                } else {
                    // å½“æ— æ³•ç¡®å®šæ–‡ä»¶å¤§å°æ—¶ï¼Œæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    loadingText.textContent = 'æ­£åœ¨åŠ è½½åŸå¸‚åœºæ™¯æ¨¡å‹...';
                }
            }

            // åŠ è½½é”™è¯¯å›è°ƒ
            function onError(error) {
                console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                loadingText.innerHTML = `
                    <div class="error-message">
                        <strong>æ¨¡å‹åŠ è½½å¤±è´¥!</strong><br>
                        <small>é”™è¯¯ä¿¡æ¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}</small><br>
                        <small>æ–‡ä»¶è·¯å¾„: ../../assets/models/city_scene.glb</small><br>
                        <small>è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</small>
                    </div>
                `;
            }

            // å¼€å§‹åŠ è½½æ¨¡å‹
            loadingText.textContent = 'å¼€å§‹åŠ è½½åŸå¸‚åœºæ™¯æ¨¡å‹...';
            
            loader.load(
                '../../assets/models/city_scene.glb',
                function(gltf) {
                    // åŠ è½½æˆåŠŸ
                    loadingText.innerHTML = `
                        <div class="success-message">
                            æ¨¡å‹åŠ è½½æˆåŠŸï¼æ­£åœ¨è®¾ç½®åœºæ™¯...
                        </div>
                    `;
                    
                    model = gltf.scene;
                    
                    // è®¾ç½®æ¨¡å‹å±æ€§
                    model.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            // ç¡®ä¿æè´¨æ­£ç¡®è®¾ç½®
                            if (child.material) {
                                child.material.side = THREE.FrontSide;
                                
                                // å¦‚æœæè´¨æ”¯æŒï¼Œå¯ç”¨é‡‘å±åº¦å’Œç²—ç³™åº¦
                                if (child.material.isMeshStandardMaterial) {
                                    child.material.envMapIntensity = 1;
                                }
                            }
                        }
                    });

                    // è®¡ç®—æ¨¡å‹è¾¹ç•Œç›’
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    // å°†æ¨¡å‹ç§»åŠ¨åˆ°ä¸­å¿ƒ
                    model.position.sub(center);
                    
                    // è®¾ç½®æ¨¡å‹æ—‹è½¬ï¼šå°†æ¨¡å‹Yè½´å¯¹é½åˆ°Three.jsçš„Zè½´
                    // ç»•Xè½´æ—‹è½¬-90åº¦ï¼Œä½¿æ¨¡å‹çš„Yè½´æŒ‡å‘Three.jsçš„Zè½´
                    model.rotation.x = -Math.PI / 2;
                    
                    // æ ¹æ®æ¨¡å‹å¤§å°è°ƒæ•´ç¼©æ”¾å’Œç›¸æœºä½ç½®
                    const maxDim = Math.max(size.x, size.y, size.z);
                    console.log('æ¨¡å‹å°ºå¯¸:', size);
                    console.log('æœ€å¤§ç»´åº¦:', maxDim);
                    
                    // å§‹ç»ˆç¼©æ”¾æ¨¡å‹åˆ°åˆé€‚å¤§å°
                    const targetSize = 60; // ç›®æ ‡å¤§å°
                    if (maxDim > 0) {
                        const scale = targetSize / maxDim;
                        model.scale.setScalar(scale);
                        console.log('åº”ç”¨ç¼©æ”¾:', scale);
                    }

                    // æ·»åŠ åˆ°åœºæ™¯
                    scene.add(model);

                    // è°ƒæ•´ç›¸æœºä½ç½®ä»¥é€‚åˆç¼©æ”¾åçš„æ¨¡å‹
                    const distance = targetSize * 0.8;
                    camera.position.set(distance * 0.8, distance * 0.2, distance * 0.8);
                    camera.lookAt(model.position);
                    controls.target.copy(model.position);
                    controls.update();

                    // æ›´æ–°æ¨¡å‹ä¿¡æ¯
                    updateModelInfo(model, gltf);

                    // éšè—åŠ è½½ç•Œé¢
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                    }, 1000);

                    console.log('æ¨¡å‹åŠ è½½æˆåŠŸ:', gltf);
                },
                onProgress,
                onError
            );
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯
        function updateModelInfo(model, gltf) {
            let vertexCount = 0;
            let faceCount = 0;
            let materialCount = 0;

            model.traverse(function(child) {
                if (child.isMesh) {
                    if (child.geometry) {
                        const geometry = child.geometry;
                        if (geometry.attributes.position) {
                            vertexCount += geometry.attributes.position.count;
                        }
                        if (geometry.index) {
                            faceCount += geometry.index.count / 3;
                        } else if (geometry.attributes.position) {
                            faceCount += geometry.attributes.position.count / 3;
                        }
                    }
                }
            });

            // ç»Ÿè®¡æè´¨æ•°é‡
            const materials = new Set();
            model.traverse(function(child) {
                if (child.material) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(mat => materials.add(mat));
                    } else {
                        materials.add(child.material);
                    }
                }
            });
            materialCount = materials.size;

            // æ›´æ–°UI
            document.getElementById('vertexCount').textContent = vertexCount.toLocaleString();
            document.getElementById('faceCount').textContent = Math.round(faceCount).toLocaleString();
            document.getElementById('materialCount').textContent = materialCount;
        }

        // è®¾ç½®UIæ§åˆ¶
        function setupUIControls() {
            // ç¼©æ”¾æ§åˆ¶
            const scaleSlider = document.getElementById('scaleSlider');
            const scaleValue = document.getElementById('scaleValue');
            scaleSlider.addEventListener('input', function() {
                if (model) {
                    const scale = parseFloat(this.value);
                    model.scale.setScalar(scale);
                    scaleValue.textContent = scale.toFixed(1);
                }
            });

            // å…‰ç…§å¼ºåº¦æ§åˆ¶
            const lightIntensity = document.getElementById('lightIntensity');
            const lightValue = document.getElementById('lightValue');
            lightIntensity.addEventListener('input', function() {
                const intensity = parseFloat(this.value);
                if (directionalLight) {
                    directionalLight.intensity = intensity;
                }
                lightValue.textContent = intensity.toFixed(1);
            });

            // ç›¸æœºæ§åˆ¶
            document.getElementById('resetCamera').addEventListener('click', function() {
                if (model) {
                    const targetSize = 10;
                    const distance = targetSize * 0.8;
                    
                    camera.position.set(distance * 0.8, distance * 0.2, distance * 0.8);
                    camera.lookAt(model.position);
                    controls.target.copy(model.position);
                    controls.update();
                }
            });

            document.getElementById('topView').addEventListener('click', function() {
                if (model) {
                    const targetSize = 10;
                    const distance = targetSize * 0.8;
                    
                    // ç”±äºæ¨¡å‹ç»•Xè½´æ—‹è½¬äº†-90åº¦ï¼Œä¿¯è§†å›¾éœ€è¦ä»Zè½´è´Ÿæ–¹å‘çœ‹
                    camera.position.set(0, distance * 0.5, -distance);
                    camera.lookAt(model.position);
                    controls.target.copy(model.position);
                    controls.update();
                }
            });

            document.getElementById('sideView').addEventListener('click', function() {
                if (model) {
                    const targetSize = 10;
                    const distance = targetSize * 0.8;
                    
                    // ä¾§è§†å›¾ä»Xè½´æ­£æ–¹å‘çœ‹
                    camera.position.set(distance, distance * 0.3, 0);
                    camera.lookAt(model.position);
                    controls.target.copy(model.position);
                    controls.update();
                }
            });

            // çº¿æ¡†æ¨¡å¼
            document.getElementById('toggleWireframe').addEventListener('click', function() {
                wireframeMode = !wireframeMode;
                if (model) {
                    model.traverse(function(child) {
                        if (child.isMesh && child.material) {
                            if (Array.isArray(child.material)) {
                                child.material.forEach(mat => mat.wireframe = wireframeMode);
                            } else {
                                child.material.wireframe = wireframeMode;
                            }
                        }
                    });
                }
                this.classList.toggle('active', wireframeMode);
            });

            // é˜´å½±å¼€å…³
            document.getElementById('toggleShadows').addEventListener('click', function() {
                shadowsEnabled = !shadowsEnabled;
                renderer.shadowMap.enabled = shadowsEnabled;
                this.classList.toggle('active', shadowsEnabled);
            });

            // é›¾æ•ˆå¼€å…³
            document.getElementById('toggleFog').addEventListener('click', function() {
                fogEnabled = !fogEnabled;
                if (fogEnabled) {
                    scene.fog = new THREE.Fog(0x1a1a2e, 50, 200);
                } else {
                    scene.fog = null;
                }
                this.classList.toggle('active', fogEnabled);
            });
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();

            // æ›´æ–°FPS
            frameCount++;
            const currentTime = Date.now();
            if (currentTime - lastTime >= 1000) {
                const fps = Math.round(frameCount * 1000 / (currentTime - lastTime));
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTime = currentTime;
            }

            // æ¸²æŸ“åœºæ™¯
            renderer.render(scene, camera);
        }

        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>